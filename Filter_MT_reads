#####Filter Metatranscriptomics reads-remove adaptors, rRNA and human reads######
#remove the adaptors 
module load trimmomatic/0.36
java -jar /share/apps/trimmomatic/0.36/trimmomatic-0.36.jar \
PE \
${sample}.r1.fastq.gz \
${sample}.r2.fastq.gz \
${sample}.trimmed.r1.fastq \
${sample}.trimmed.se.r1.fastq \
${sample}.trimmed.r2.fastq \
${sample}.trimmed.se.r2.fastq \
ILLUMINACLIP:TruSeq3-PE-2.fa:2:30:10 \
LEADING:3 \
TRAILING:3 \
SLIDINGWINDOW:4:15 \
MINLEN:28 \

#combine the files
module load python/intel/2.7.12

python interleave-fastq.py ${sample}.trimmed.r1.fastq ${sample}.trimmed.r2.fastq > ${sample}.trimmed.interleaved.fastq
cat ${sample}.trimmed.se.r1.fastq ${sample}.trimmed.se.r2.fastq > ${sample}.trimmed.se.fastq

#remove rRNA sequences 
module load sortmerna/intel/2.1b

./share/apps/sortmerna/2.1b/intel/sortmerna  --ref ./sortmeRNA_database/rfam-5.8s-database-id98.fasta,./sortmeRNA_database/rfam-5.8s-database-id98.db:./sortmeRNA_database/rfam-5s-database-id98.fasta,./sortmeRNA_database/rfam-5s-database-id98.db:./sortmeRNA_database/silva-arc-16s-id95.fasta,./sortmeRNA_database/silva-arc-16s-id95.db:./sortmeRNA_database/silva-arc-23s-id98.fasta,./sortmeRNA_database/silva-arc-23s-id98.db:./sortmeRNA_database/silva-bac-16s-id90.fasta,./sortmeRNA_database/silva-bac-16s-id90.db:./sortmeRNA_database/silva-bac-23s-id98.fasta,./sortmeRNA_database/silva-bac-23s-id98.db:./sortmeRNA_database/silva-euk-18s-id95.fasta,./sortmeRNA_database/silva-euk-18s-id95.db:./sortmeRNA_database/silva-euk-28s-id98.fasta,./sortmeRNA_database/silva-euk-28s-id98.db --otu_map -a 20 -m 4096 --paired_in --other ${sample}.trimmed.interleaved.non-rRNA --fastx --log --reads ${sample}.trimmed.interleaved.fastq --aligned ${sample}.trimmed.interleaved.rRNA
./share/apps/sortmerna/2.1b/intel/sortmerna --otu_map -a 20 -m 4096 --aligned ${sample}.trimmed.se.rRNA --other ${sample}.trimmed.se.non-rRNA --fastx --log --reads ${sample}.trimmed.se.fastq --ref ./sortmeRNA_database/rfam-5.8s-database-id98.fasta,./sortmeRNA_database/rfam-5.8s-database-id98.db:./sortmeRNA_database/rfam-5s-database-id98.fasta,./sortmeRNA_database/rfam-5s-database-id98.db:./sortmeRNA_database/silva-arc-16s-id95.fasta,./sortmeRNA_database/silva-arc-16s-id95.db:./sortmeRNA_database/silva-arc-23s-id98.fasta,./sortmeRNA_database/silva-arc-23s-id98.db:./sortmeRNA_database/silva-bac-16s-id90.fasta,./sortmeRNA_database/silva-bac-16s-id90.db:./sortmeRNA_database/silva-bac-23s-id98.fasta,./sortmeRNA_database/silva-bac-23s-id98.db:./sortmeRNA_database/silva-euk-18s-id95.fasta,./sortmeRNA_database/silva-euk-18s-id95.db:./sortmeRNA_database/silva-euk-28s-id98.fasta,./sortmeRNA_database/silva-euk-28s-id98.db


#remove the human, flu and phix reads 
module load deconseq/0.4.3

cat ${sample}.trimmed.interleaved.non-rRNA.fastq ${sample}.trimmed.se.non-rRNA.fastq > ${sample}.trimmed.non-rRNA.fastq
perl  ./deconseq-standalone-0.4.3/deconseq.pl -id ${sample}.trimmed.non-rRNA.non-human_phix  -f ${sample}.trimmed.non-rRNA.fastq  -dbs hg19_phix_index  -out_dir ./mydir

#extract paired end reads from the filtered reads files 
python  extract-paired-reads-from-one-file.py  ${sample}.trimmed.non-rRNA.non-human_phix_clean.fq  ${sample}.clean

#interleave the fastq files
python interleave-fastq.py ${sample}.clean.r1.fq  ${sample}.clean.r2.fq > ${sample}.final.interleaved.fastq

